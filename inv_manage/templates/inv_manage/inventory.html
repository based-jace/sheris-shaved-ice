{% extends 'inv_manage/main.html' %}

{% load static %}

{% block main %}
<script>
    let table_items = {{ json_items|safe }};
</script>

<h1 class="page-header dark-logo">Inventory</h1>
<a href="{% url 'inv_manage:add_item' %}">add an item</a>

    {% csrf_token %}
    <table id="data-table">
        <tr>
            <th class='check-column'><input type="checkbox" name="{{item.id}}" value="{{item.id}}"></th>
            <th scope="col"><a class="sort-column" sort-name="name">Name</a></th>
            <th scope="col"><a class="sort-column" sort-name="description">Description</a></th>
            <th scope="col"><a class="sort-column" sort-name="type">Type</a></th>
            <th scope="col"><a class="quantity-column sort-column" sort-name="quantity">Quantity</a></th>
            <th class='edit-column'>Edit</th>
            <th class="delete-column">X</th>
        </tr>
        {% if items|length > 0 %}
        <tr v-for="item in items">
            <span>
                <td class="center"><input type="checkbox" name="checkbox" v-bind:value="item.id"></td>
                <td>[[item.name]]</td>
                <td>[[item.description]]</td>
                <td>[[item.type]]</td>
                <td class="center">[[item.quantity]]</td>
                <td><a v-bind:href="item.edit_url">x</a></td>
                <td><button type="button" class='single-delete'>X</button></td>
            </span>
        </tr> 
        {% endif %}
    </table>
    <div class="center-pagination">
        <div class="pagination">
            <button href="#" type="button" class='left-table-page'>&laquo;</button>
        </div>
        <div class="pagination-page-number">
            <button href="#" class='table-page-number'>1</button>
        </div>
        <div class="pagination">
            <button href="#" type="button" class='right-table-page'>&raquo;</button>
        </div>
        <div class="pagination">    
            <button id="delete-selected" type="button" class='submit-btn'>Delete Selected</button>  
        </div> 
    </div>

{% endblock %}
{% block after_scripts %}
    <script src="{% static 'js/colResizable.min.js' %}"></script>
    <script src="{% static 'js/table.js' %}"></script>
    <script>
        subButtons = document.getElementsByClassName('single-delete');
        groupDeleteButton = document.getElementById('delete-selected');
        boxes = document.getElementsByName('checkbox');
        function getSelectedCheckboxes(){
            let checkboxes = [];
            for(let i = 0; i < boxes.length;++i){
                if(boxes[i].checked == true){
                    
                    checkboxes.push(boxes[i].value);
                }
            }
            return checkboxes;
        }

        function removeItem(box){
            let elem = box.parentElement.parentElement;
            elem.parentNode.removeChild(elem);
        }

        

        function removeItems(){
            let elements = [];
            for(let i = boxes.length-1; i >= 0;--i){
                if(boxes[i].checked == true){
                    let elem = boxes[i].parentElement.parentElement;
                    elem.parentNode.removeChild(elem);                   
                }
            }
        }

        function deleteItem(box){
            $.ajax({
                type:"POST",
                url:"{% url 'inv_manage:inventory' %}",                
                data:{
                    'checkbox[]':box.value,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success:function(data){
                    removeItem(box);
            },
                failure:function(data){
                    alert('Theres a problem');
                }
            })
        }
        
        function deleteItems(){
            checkboxes = getSelectedCheckboxes()
            $.ajax({
                type:"POST",
                url:"{% url 'inv_manage:inventory' %}",                
                data:{
                    'checkbox':checkboxes,
                    csrfmiddlewaretoken: '{{ csrf_token }}'
                },
                success:function(data){
                    removeItems();
            },
                failure:function(data){
                    alert('Theres a problem');
                }
            })
        }

        function setUpButtons(){
            for(let i = 0; i < subButtons.length;++i){
                subButtons[i].onclick = function(){deleteItem(boxes[i]);};
            }
            groupDeleteButton.onclick = deleteItems;    
        }

        setUpButtons();

    </script>
{% endblock %}